---
title: "Stokes cut comparer"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
runtime: shiny
resource_files:
- out/joined.rds
- out/cagrs.rds
- out/internal_vs_stokes.rds
- data/lmo64_agg_stokes_mapping.csv
- out/lfs_data.csv
- out/industry_shares.csv
- out/region_shares.csv
- github.png
---

```{r, include=FALSE}
library(tidyverse)
start_year <- today()-years(1) # get rid of -1 once we have this year's data
library(here)
library(readxl)
library(janitor)
library(conflicted)
library(htmlwidgets) #for function onRender
conflicts_prefer(dplyr::filter)
options(scipen = 999)
min_abs_original <- 10
#functions-----------------------
share_plot <- function(tbbl, facet_var){
  ggplot(tbbl, aes(year, share, colour=source))+
    geom_line()+
    scale_y_continuous(labels = scales::percent)+
    facet_wrap(~fct_reorder(get(facet_var), share, .desc = TRUE), scales = "free")+
    labs(x=NULL,y=NULL)+
  theme(text = element_text(size = 14), legend.position = "bottom")
}

my_dt <- function(tbbl) {
  DT::datatable(tbbl,
                extensions = "Buttons",
                rownames = FALSE,
                filter="top",
                options = list(
                  columnDefs = list(list(className = "dt-center", targets = "_all")),
                  paging = TRUE,
                  scrollX = TRUE,
                  scrollY = TRUE,
                  searching = TRUE,
                  ordering = TRUE,
                  dom = "Btip",
                  buttons = list(
                    list(extend = "csv", filename = "top_5_cor_education"),
                    list(extend = "excel", filename = "top_5_cor_education")
                  ),
                  pageLength = 64,
                  lengthMenu = c(3, 5)
                )
  )
}

cagr_plot <- function(tbbl, xvar, yvar, highlight_industry){
  filtered <- tbbl|>
    filter(industry==highlight_industry)
  plt <- ggplot(cagrs, aes({{  xvar  }}, {{  yvar  }},
                         text=paste0("Industry: ",
                                     industry,
                                     "\n Internal CAGR = ",
                                     scales::percent({{  xvar  }}, accuracy = .1),
                                     "\n Stokes CAGR = ",
                                     scales::percent({{  yvar  }}, accuracy = .1))))+
  geom_abline(slope=1, intercept = 0, colour="white", lwd=1.5)+
  geom_point(data=filtered, size=4, colour="red", alpha=.5)+    
  geom_point(alpha=.5)+
  scale_x_continuous(labels=scales::percent)+
  scale_y_continuous(labels=scales::percent)+
  labs(x="internal forecast",
       y="stokes forecast")
  plotly::ggplotly(plt, tooltip="text")
}
```

```{r}
joined <- read_rds(here("out","joined.rds"))
internal_vs_stokes <- read_rds(here("out","internal_vs_stokes.rds"))
cagrs <- read_rds(here("out","cagrs.rds"))
mapping <- read_csv(here("data","lmo64_agg_stokes_mapping.csv"))
lfs_data <- read_csv(here("out","lfs_data.csv"))
industry_shares <- read_csv(here("out","industry_shares.csv"))|>
  mutate(industry=str_trunc(industry, 30, "right"))
region_shares <- read_csv(here("out","region_shares.csv"))
files <- sort(unique(joined$which_file), decreasing = TRUE)
```

Comparison with previous cut
=====================================  

Inputs {.sidebar data-width=400}
-------------------------------------

*  This app allows one to visualize what has changed between Stokes cuts, and how employment compares with our internal forecast.
*  The heatmap on this page illustrates the degree of difference between the final macro cut of 2023 and the first macro cut of 2024.
*  Dark colours indicate little difference between cuts:  yellow indicates a (relatively) large difference.
*  You can zoom in by highlighting (click-dragging) a region of the heatmap. 
*  You can **CLICK** on a row in the heatmap to see the underlying data.
*  To zoom back out double click anywhere in the heatmap.


```{r}
selectInput(
  "file",
  "Select an excel file to compare",
  files,
  selected = files[1]
)

filtered <- reactive({
  joined|>
    filter(which_file==input$file)
})

renderUI({#need the render UI because the list of choices depends on the excel file
selectInput(
  "sheet",
  "Select a sheet to compare",
  unique(filtered()$sheet),
  selected = unique(filtered()$sheet)[1]
)
})

reactive_base <- reactive({
  temp <- joined|>
    filter(which_file==input$file, 
           sheet==input$sheet
           )|>
    pull(joined)
  
  temp[[1]]|>
    filter(year>=year(today()))|>
    group_by(variable)|>
    mutate(original=if_else(min(abs(original_value)) < min_abs_original, "small", "large"),
           change=if_else(original=="small", 
                          new_value-original_value, 
                          (new_value-original_value)/abs(original_value)*100),
           change=round(log10(abs(change)+1),3)
           )
})
  
 reactive_tbbl <- reactive({
   reactive_base()|>
    select(-new_value, -original_value, -original)|>
    pivot_wider(names_from = "year", values_from = "change")|>
    column_to_rownames("variable")|>
    remove_empty("rows")
 })

reactive_show_labels <- reactive({
  if_else(nrow(reactive_tbbl())<80, TRUE, FALSE)
})
```
 
 
Source code: [![github logo](github.png){width=100px}](https://github.com/bcgov/compare_excel){target='_blank'}
 
 
 
Column {data-width=550}
-------------------------------------
    
### `r renderUI({ paste(input$file, input$sheet, sep=": ")})`
    
```{r}
js <- "
function(el, x) {
  el.on('plotly_click', function(d) {
    var point = d.points[0];
    Shiny.setInputValue('point', {y: point.y});
  });
}"

plotly::renderPlotly({
  req(input$file)
  req(input$sheet)
  heatmaply::heatmaply(reactive_tbbl(), 
                         dendrogram=FALSE, 
                         key.title="Degree of Difference", 
                         fontsize_row = 8, 
                         showticklabels = c(TRUE, reactive_show_labels()))|>
    plotly::config(displayModeBar = FALSE)|>
    onRender(js)
})
```

Column {data-width=450}
-------------------------------------

### A plot of the original and new values of row...

```{r}
plotly::renderPlotly({
  req(input$point)
  plt <- reactive_base()|>
    filter(variable==rev(rownames(reactive_tbbl()))[input$point$y])|>
    ungroup()|>
    select(year, new_value, original_value)|>
    pivot_longer(cols = -year)|>
    mutate(year=as.numeric(year))|>
    ggplot(aes(year,value, colour=name))+
    geom_line()+
    labs(title=rev(rownames(reactive_tbbl()))[input$point$y])
  plotly::ggplotly(plt)
})
```


### The data:

```{r}
#plotly::renderPlotly({
DT::renderDT({ 
  req(input$point)
  reactive_base()|>
    filter(variable==rev(rownames(reactive_tbbl()))[input$point$y])|>
    select(year, new_value, original_value, change)|>
    DT::datatable( rownames = FALSE)
})
```



Comparison with internal employment forecast
=====================================  

Column
-------------------------------------
    
### Degree of difference between internal and stokes:  **CLICK** on row to choose industry
    
```{r}

js2 <- "
function(el, x) {
  el.on('plotly_click', function(d) {
    var point = d.points[0];
    Shiny.setInputValue('point2', {y: point.y});
  });
}"

temp <- internal_vs_stokes|>
  mutate(change=(stokes_cut/internal-1)*100,
         degree_of_difference=round(log10(abs(change)+1),3))|>
  select(industry, name, degree_of_difference)|>
  filter(name>2023)|>
  pivot_wider(id_cols = industry, names_from = "name", values_from = "degree_of_difference")|>
  column_to_rownames("industry")

  heatmaply::heatmaply(temp, dendrogram=FALSE, key.title="Degree of Difference", showticklabels = c(TRUE, FALSE))|>
  onRender(js2)
```
 
Column
------------------------------------- 
 
### First five year CAGRs 
    
```{r}
plotly::renderPlotly({
req(input$point2)  
cagr_plot(cagrs, internal_cagr_ffy, stokes_cagr_ffy, rev(rownames(temp))[input$point2$y])
})  
``` 


### Second five year CAGRs
    
```{r}
plotly::renderPlotly({
req(input$point2)    
cagr_plot(cagrs, internal_cagr_sfy, stokes_cagr_sfy, rev(rownames(temp))[input$point2$y])
})  
```

Column
------------------------------------- 

### Ten year CAGRs

```{r}
plotly::renderPlotly({
req(input$point2)    
cagr_plot(cagrs, internal_cagr_ty, stokes_cagr_ty, rev(rownames(temp))[input$point2$y])
})  
```

### `r renderUI({rev(rownames(temp))[input$point2$y]})` relative to LFS Data


```{r}
reactive_tbbl2 <- reactive({
 internal_vs_stokes|>
    mutate(date=ymd(paste(name,"06","15", sep="-")))|>
    filter(date>start_year)|>
    select(-name, -stokes_growth)|>
    pivot_longer(cols=c(stokes_cut, internal), names_to = "series", values_to = "value")|>
    full_join(lfs_data)|>
    filter(industry==rev(rownames(temp))[input$point2$y])
})

reactive_lfs_last_year <- reactive({
  lfs_data|>
    filter(industry==rev(rownames(temp))[input$point2$y])|>
    group_by(industry)|>
    mutate(value=zoo::rollmean(value, 12, align = "right", fill=NA),
           series="12 month rolling mean of LFS")
})

plotly::renderPlotly({
  req(input$point2) 
  plt <- ggplot(reactive_tbbl2(), aes(date, value, colour=series))+
    geom_line(alpha=.5)+
    geom_line(data=reactive_lfs_last_year())+
    scale_y_continuous(labels = scales::comma)+
    scale_colour_brewer(palette = "Dark2")+
    labs(x=NULL,
         y=NULL,
         colour=NULL)
  plotly::ggplotly(plt)|>
    plotly::layout(legend = list(orientation = "h", x = 0.4, y = -0.2))
})
```

Regional shares by industry
===================================== 

Inputs {.sidebar}
-------------------------------------

```{r}
selectInput(
  "industry",
  "Select an industry",
  unique(region_shares$industry),
  selected = unique(region_shares$industry)[1]
)
```

Column 
------------------------------------- 

### `r renderUI({input$industry})`

```{r}
plotly::renderPlotly({
  plt <- region_shares|>
    filter(industry==input$industry)|>
    mutate(bc_region=fct_reorder(bc_region, share, max, .desc = TRUE))|>
    ggplot(aes(year, share, colour=source))+
    geom_line()+
    scale_y_continuous(labels=scales::percent)+
    facet_wrap(~bc_region, scales = "free_y")
plotly::ggplotly(plt)    
})
```


Industry shares by region
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
selectInput(
  "region",
  "Select a region",
  unique(industry_shares$bc_region),
  selected = unique(industry_shares$bc_region)[1]
)
```

Column
------------------------------------- 

### `r renderUI({input$region})`

```{r}
plotly::renderPlotly({
  plt <- industry_shares|>
    filter(bc_region==input$region)|>
    mutate(industry=fct_reorder(industry, share, max, .desc = TRUE))|>
    ggplot(aes(year, share, colour=source))+
    geom_line()+
    scale_y_continuous(labels=scales::percent)+
    facet_wrap(~industry, scales = "free_y")
plotly::ggplotly(plt)    
})
```




Mapping from LMO industries to Stokes industries
===================================== 

```{r}
my_dt(mapping)
```



